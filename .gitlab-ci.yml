################################################################################
# Gitlab CI samples for Drupal / Php project, code quality and deploy.
#
# Project: https://gitlab.com/mog33/gitlab-ci-drupal
# Documentation: https://gitlab.com/mog33/gitlab-ci-drupal
# Author: Jean Valverde contact@dev-drupal.com
# License: GPL-3
#
# This file is way too huge for a normal CI process, this is just a commented
# example of working jobs for Drupal 8, feel free to cherry pick what you need.
#
# For Gilab CI help on this file see:
#   https://docs.gitlab.com/ee/ci/yaml
#
################################################################################
variables:
  # Common variables for all jobs, edit this part to your needs.
  #
  # Make CI more verbose in case of problem.
  # CI_DEBUG_TRACE: "1"
  #
  # Global settings for all env used for deploy.
  # USER_NAME: "ubuntu"
  # DRUPAL_FOLDER: "/var/www/htdocs/MY_DRUPAL_ROOT"
  # For Scss support when build in case of a Drupal Bootstrap sub theme.
  # THEME: "MY_THEME_NAME"
  # Deploy environments configuration, add or remove depending deploy jobs.
  # Testing config, set host or ip
  TESTING_HOST: "localhost"
  # Staging config, set host or ip
  STAGING_HOST: "localhost"
  # Production config, set host or ip
  PRODUCTION_HOST: "localhost"
  #
  # Drupal custom code / theme / all code. We are checking our code quality,
  # and optionally Drupal core.
  #
  # Path is relative to project root, web/ is for Drupal Composer template,
  # change it if you are using docroot/ or any other web root.
  WEB_ROOT: "web"
  # Test unit folder relative to web root.
  UNIT_TEST_ROOT: "modules/custom"
  # If you have a MySQL dump for testing to avoid installing.
  UNIT_TEST_DUMP: "https://gitlab.com/mog33/gitlab-ci-drupal/uploads/13ca902a6988548f45b276389cbd3d42/dump.tar.xz"
  # Comma separated for phpqa and phpmetrics.
  PHP_CODE: "${WEB_ROOT}/modules/custom,${WEB_ROOT}/themes/custom"
  # Space separated for eslint and sass lint.
  JS_CODE: "${WEB_ROOT}/modules/custom/**/*.js ${WEB_ROOT}/themes/custom/**/*.js"
  JS_CODE_IGNORE: "**/bootstrap/**/*"
  CSS_FILES: "${WEB_ROOT}/themes/custom/**/css/*.css"
  SCSS_FILES: "${WEB_ROOT}/themes/custom/**/scss/*.scss"
  SASS_CONFIG: "./.sass-lint.yml"
  # Ignore files and dir for all Phpqa tools.
  PHPQA_IGNORE_DIRS: "--ignoredDirs vendor,bootstrap"
  PHPQA_IGNORE_FILES: "--ignoredFiles Readme.md,style.css,print.css"
  # See Phpqa available tools:
  #   https://github.com/EdgedesignCZ/phpqa#available-tools
  # Allow some errors, this will stop the pipeline if a limit is reached.
  TOOLS: "--tools phpcs:1,phpmd,phpcpd,security-checker:0,parallel-lint"
################################################################################
  # Next part do not need to be edited for a first quick run.
  #
  # Phpqa docker image tag and options like code to analyse relative to your 
  # project root.
  #   https://hub.docker.com/r/zdenekdrahos/phpqa/tags/
  PHPQA: "v1.19.0"
  # Phpmetrics use the last phar release.
  #   https://github.com/phpmetrics/PhpMetrics/releases
  PHPMETRICS: "v2.4.1"
  # All reports will be available in artifacts from this folder.
  REPORT_DIR: "reports"
  # Drupal coding standards for Code Sniffer (phpcs) are provided by Coder module.
  #   https://www.drupal.org/project/coder
  DRUPAL_CODER: "2.12"
  # Options for Phpqa to build a report to download, need artifacts set on the
  # job, see '.report' below.
  PHPQA_REPORT: "--report --buildDir ${REPORT_DIR}"
  PHPQA_PHP_CODE: "--analyzedDirs ${PHP_CODE} ${PHPQA_IGNORE_DIRS} ${PHPQA_IGNORE_FILES}"
  PHPQA_ALL_CODE: "--analyzedDirs ${WEB_ROOT} ${PHPQA_IGNORE_DIRS} ${PHPQA_IGNORE_FILES}"

################################################################################
# Define your stages, this will be "pipelines" in gitlab.
#   https://docs.gitlab.com/ee/ci/pipelines.html
################################################################################

stages:
  - build
  - test
  - code quality
  - code lint
  - php code metrics
  - deploy to testing
  - deploy to staging
  - deploy to production

################################################################################
# Gitlab ci templates for common jobs to avoid repeat, see
#   https://docs.gitlab.com/ee/ci/yaml/#anchors
################################################################################

# Use Phpqa docker image, see https://github.com/EdgedesignCZ/phpqa#docker
# We download the coder project to use the coding standard ruleset for
# Code_Sniffer, composer install is slow.
.phpqa_template: &phpqa_template
  image: zdenekdrahos/phpqa:${PHPQA}
  before_script:
    - if [ ! -d ./coder/coder_sniffer ];
      then
        curl -fsSL https://ftp.drupal.org/files/projects/coder-8.x-${DRUPAL_CODER}.tar.gz -o coder.tar.gz;
      fi
    - if [ -f coder.tar.gz ];
      then
        tar xzf coder.tar.gz;
      fi
    - mkdir -p ${REPORT_DIR}
    - chmod -R 777 ${REPORT_DIR}
  artifacts:
    paths:
      - ${REPORT_DIR}/*.html
    # Name will be based on job and branch.
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    # How long do we keep reports files?
    expire_in: 1 week
    # Force artifacts even if the job fail.
    when: always

# We use Phpmetrics for metrics report.
# Is included in phpqa but standalone provide the last version with more
# report information.
.phpqmetrics_template: &phpqmetrics_template
  image: composer:latest
  before_script:
    - curl -fSL https://github.com/phpmetrics/PhpMetrics/releases/download/${PHPMETRICS}/phpmetrics.phar -o phpmetrics
    - chmod +x phpmetrics
    - mkdir -p ${REPORT_DIR}
  artifacts:
    paths:
      - ${REPORT_DIR}/*.html
    # Name will be based on job and branch.
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    # How long do we keep reports files?
    expire_in: 1 week
    # Force artifacts even if the job fail.
    when: always

# Use Node docker image for Eslint.
.node_template: &node_template
  image: node:8-alpine
  before_script:
    - mkdir -p ${REPORT_DIR}
    - chmod -R 777 ${REPORT_DIR}

# Use Ruby docker image for Markdown lint.
.ruby_template: &ruby_template
  image: ruby:2-alpine
  before_script:
    - mkdir -p ${REPORT_DIR}
    - chmod -R 777 ${REPORT_DIR}

# Basic docker image with ssh to be able to access a remote.
# Each access must add a ssh key, see samples below.
.ssh_agent_template:
  before_script: &ssh_agent_template
    - apk --no-cache add openssh-client
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Avoid warning on connection.
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

# Sample of a build, considering a Drupal 8 with composer, Bootstrap Sass.
# For more samples see
#   https://docs.gitlab.com/ee/ci/examples/deployment/composer-npm-deploy.html
.build_template: &build_template
  image: composer:latest
  services:
    - mariadb:10.3
  script:
    - composer global require hirak/prestissimo
        --no-progress --no-suggest --ignore-platform-reqs
    # Sample to install a Drupal 8 with drupal composer template.
    # - mkdir -p build-${CI_JOB_NAME}
    # - composer create-project drupal-composer/drupal-project:8.x-dev build-${CI_JOB_NAME}
    #     --stability dev --no-interaction --ignore-platform-reqs --quiet
    # - cp -r build-${CI_JOB_NAME}/* .
    # - rm -rf build-${CI_JOB_NAME}
    # Install project libraries and dependencies from a local composer.json
    # - composer install
    #   --dev --ignore-platform-reqs --no-suggest --no-interaction --quiet
    # Install and use compass if using Sass file in the theme.
    # - apk --no-cache add ruby ruby-dev libffi-dev build-base
    # - gem install --no-document listen sass compass bootstrap-sass
    # - compass compile ${WEB_ROOT}/themes/custom/${THEME}
    - apk --no-cache add curl
    - curl -fsSl https://codeload.github.com/drupal-composer/drupal-project/tar.gz/8.x -o drupal.tar.gz
    - tar -xzf drupal.tar.gz
    - mv drupal-project-8.x drupal
    - rm -f drupal.tar.gz
    # check if not already from cache.
    - if [ ! -f ./drupal/web/index.php ];
      then
        composer install --working-dir drupal --prefer-dist --no-suggest --no-interaction -vvv
      fi
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    paths:
      # Folders from Drupal template, add any folders/files you need.
      - ./drupal
    expire_in: 1 day
  variables:
    MYSQL_ALLOW_EMPTY_PASSWORD: "1"
    DB_URL: "mysql://root@mariadb/drupal8"

# Testing template for phpunit, this provide Apache / Php.
.test_template: &test_template
  # Build is not for master but only some other branches.
  except:
    - master
  only:
    - testing
  image: juampynr/drupal8ci:latest
  services:
    - mariadb:10.3
    # - selenium/standalone-chrome-debug:3.7.1-beryllium
  before_script:
    - mkdir -p /var/www/html
    - ln -s ${WEB_ROOT} /var/www/html/web
    - apache2-foreground&
    - mkdir -p ${REPORT_DIR}
    - chmod -R 777 ${REPORT_DIR}
    - cp config/phpunit.xml ${WEB_ROOT}/core/
    - mkdir -p ${BROWSERTEST_OUTPUT_DIRECTORY}
    - chmod -R 777 ${BROWSERTEST_OUTPUT_DIRECTORY}
  variables:
    MYSQL_ALLOW_EMPTY_PASSWORD: "1"
    DB_URL: "mysql://root@mariadb/drupal8"
    SIMPLETEST_DB: "mysql://root@mariadb/drupal8"
    SIMPLETEST_BASE_URL: "http://localhost"
    BROWSERTEST_OUTPUT_DIRECTORY: "${CI_PROJECT_DIR}/${WEB_ROOT}/sites/simpletest"
  artifacts:
    paths:
      - ${REPORT_DIR}/*

################################################################################
# Jobs definition.
#   https://docs.gitlab.com/ee/ci/pipelines.html#jobs
#
# All jobs are set in a stage.
################################################################################

################################################################################
# Build and tests jobs, not for master.
################################################################################

# Build only when not on master.
Build:
  stage: build
  <<: *build_template
  except:
    - master
  after_script:
    - cp ${CI_PROJECT_DIR}/config/settings.php ${WEB_ROOT}/sites/default/
    # If a dump exist from the cache of a previous build, we try to use it.
    - if [ ! -f ${CI_PROJECT_DIR}/dump/dump.sql ];
      then
        mkdir -p dump;
        curl -fsSL ${UNIT_TEST_DUMP} -o dump/dump.tar.xz;
        tar xf dump/dump.tar.xz -C dump;
      fi
    # We import the dump, faster than a site install.
    - if [ -f ${CI_PROJECT_DIR}/dump/dump.sql ];
      then
        apk --no-cache add mysql-client;
        mysql -hmariadb -uroot -e "CREATE DATABASE drupal8 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci";
        mysql -hmariadb -uroot drupal8 < ${CI_PROJECT_DIR}/dump/dump.sql;
      else
        echo "Missing database dump!";
      fi
  # On build we cache the composer, web and dump folders.
  cache:
    key: drupal-build-cache
    paths:
      - drupal
      - dump

# Job to run Unit and Kernel tests, do not require a build.
Unit and kernel tests:
  stage: test
  <<: *test_template
  script:
    - cd ${WEB_ROOT}
    - sudo -E -u www-data
      ../vendor/bin/phpunit
        -c core
        --log-junit ../${REPORT_DIR}/phpunit.xml
        --testdox-html ../${REPORT_DIR}/phpunit.html
        ${UNIT_TEST_ROOT}

# Job to run Web tests, need a build.
Web tests:
  stage: test
  dependencies:
    - Build
  <<: *test_template
  script:
    - cd ${WEB_ROOT}
    - sudo -E -u www-data
      ../vendor/bin/phpunit
        -c core
        --log-junit ../${REPORT_DIR}/phpunit.xml
        --testdox-html ../${REPORT_DIR}/phpunit.html
        --group Drupal
        ${UNIT_TEST_ROOT}

# Job to check test coverage, need a build.
Code coverage:
  stage: test
  dependencies:
    - Build
  <<: *test_template
  script:
    # Create the needed folders.
    - mkdir -p ${BROWSERTEST_OUTPUT_DIRECTORY}
    - chmod -R 777 ${BROWSERTEST_OUTPUT_DIRECTORY}
    - mkdir -p ${REPORT_DIR}/coverage-xml
    - mkdir -p ${REPORT_DIR}/coverage-html
    - chmod -R 777 ${REPORT_DIR}
    - cd ${WEB_ROOT}
    - timeout 60m sudo -E -u www-data
      ../vendor/bin/phpunit
        -c core
        --coverage-xml ../${REPORT_DIR}/coverage-xml
        --coverage-html ../${REPORT_DIR}/coverage-html
        --testsuite nonfunctional
        ${UNIT_TEST_ROOT}

################################################################################
# Code quality and code lint jobs.
################################################################################

# Automated quality check job when something is pushed/merged on master.
# We have a limit on errors we accept on the tools, if failed we run a
# report and stop.
Code quality:
  stage: code quality
  <<: *phpqa_template
  script:
    - phpqa ${PHPQA_REPORT} ${TOOLS} ${PHPQA_PHP_CODE}
  # Limit to branch push, for more options see
  # https://docs.gitlab.com/ee/ci/yaml/#only-and-except-simplified
  only:
    - branches

# Drupal coding standard best practices report (can not be included in
# codequality as we are already running Drupal coding standard).
Best practices:
  stage: code quality
  <<: *phpqa_template
  script:
    - phpqa ${PHPQA_REPORT}
        --config ./phpqa_config/phpcs_drupal_best_practices
        --tools phpcs:1
        ${PHPQA_PHP_CODE}
  only:
    - branches
  # Allow failure to produce report and warning.
  allow_failure: true

# This is a eslint report based on Drupal 8.5.x standards.
Eslint:
  stage: code lint
  <<: *node_template
  artifacts:
    paths:
      - ${REPORT_DIR}/es-lint-report.html
    # Name will be based on job and branch.
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    # How long do we keep reports files?
    expire_in: 1 week
    # Force artifacts even if the job fail.
    when: always
  script:
    # We grab the standards, not needed if after a build.
    - apk --no-cache add curl
    - mkdir -p ${WEB_ROOT}/core
    - curl -fsSL https://cgit.drupalcode.org/drupal/plain/core/.eslintrc.json -o ${WEB_ROOT}/core/.eslintrc.json
    # Drupal 8.6.x specfic rules override for passing.
    - curl -fsSL https://cgit.drupalcode.org/drupal/plain/core/.eslintrc.passing.json -o ${WEB_ROOT}/core/.eslintrc.passing.json
    # Install eslint airbnb standard.
    - npm install -g eslint@^5.9.0 eslint-config-airbnb@^17.1.0
        eslint-plugin-import@^2.14.0 eslint-plugin-jsx-a11y@^6.1.1
        eslint-plugin-react@^7.11.0 eslint-plugin-prettier@^3.0.0
        eslint-config-prettier@^3.3.0 prettier@^1.15.2
    # Fix Error https://github.com/npm/uid-number/issues/3#issuecomment-291362937
    - npm config set unsafe-perm true
    # Run the eslint command to generate a report.
    - eslint
        --config ./${WEB_ROOT}/core/.eslintrc.passing.json
        --format html
        --output-file ${REPORT_DIR}/es-lint-report.html
        --ignore-pattern ${JS_CODE_IGNORE}
        ${JS_CODE}
  # Allow failure to produce report and warning.
  allow_failure: true

# Drupal 8.6+ rules used here for css lint.
Css lint:
  stage: code lint
  <<: *node_template
  artifacts:
    paths:
      - ${REPORT_DIR}/css-lint-report.txt
    # Name will be based on job and branch.
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    # How long do we keep reports files?
    expire_in: 1 week
    # Force artifacts even if the job fail.
    when: always
  script:
    # We grab the Drupal standards, not needed if after a build.
    - apk --no-cache add curl
    - curl -fsSL https://cgit.drupalcode.org/drupal/plain/core/.stylelintrc.json -o ${WEB_ROOT}/.stylelintrc.json
    - npm install -g stylelint stylelint-config-standard stylelint-no-browser-hacks
    # Fix Error https://github.com/npm/uid-number/issues/3#issuecomment-291362937
    - npm config set unsafe-perm true
    - stylelint "./${CSS_FILES}" > ${REPORT_DIR}/css-lint-report.txt
  allow_failure: true

# This is a scss lint report, Drupal 8.6+ rules used here.
Scss lint:
  stage: code lint
  <<: *node_template
  artifacts:
    paths:
      - ${REPORT_DIR}/scss-lint-report.txt
    # Name will be based on job and branch.
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    # How long do we keep reports files?
    expire_in: 1 week
    # Force artifacts even if the job fail.
    when: always
  script:
    # We grab the Drupal standards, not needed if after a build.
    - apk --no-cache add curl
    - curl -fsSL https://cgit.drupalcode.org/drupal/plain/core/.stylelintrc.json -o ${WEB_ROOT}/.stylelintrc.json
    - npm install -g stylelint stylelint-scss stylelint-no-browser-hacks stylelint-order stylelint-config-standard stylelint-config-recommended-scss
    # Fix Error https://github.com/npm/uid-number/issues/3#issuecomment-291362937
    - npm config set unsafe-perm true
    - stylelint "./${SCSS_FILES}" > ${REPORT_DIR}/scss-lint-report.txt
  allow_failure: true

# This is a sass lint report, default rules used here.
Sass lint:
  stage: code lint
  <<: *node_template
  artifacts:
    paths:
      - ${REPORT_DIR}/sass-lint-report.html
    # Name will be based on job and branch.
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    # How long do we keep reports files?
    expire_in: 1 week
    # Force artifacts even if the job fail.
    when: always
  script:
    - apk --no-cache add git
    # Project seems a bit outdated, an ongoing tag is currently more up to date.
    - npm install -g git://github.com/sasstools/sass-lint.git#1.13.0
    # Fix Error https://github.com/npm/uid-number/issues/3#issuecomment-291362937
    - npm config set unsafe-perm true
    - 'sass-lint --config ${SASS_CONFIG}
        --verbose
        --no-exit
        --format html
        --output ${REPORT_DIR}/sass-lint-report.html'
  allow_failure: true

# This is a markdown lint report, based on generic default rules.
Markdown lint:
  stage: code lint
  <<: *ruby_template
  artifacts:
    paths:
      - ${REPORT_DIR}/markdown_lint.txt
    # Name will be based on job and branch.
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    # How long do we keep reports files?
    expire_in: 1 week
    # Force artifacts even if the job fail.
    when: always
  script:
    - gem install mdl
    - mdl ./ > ${REPORT_DIR}/markdown_lint.txt
  allow_failure: true
  when: manual

################################################################################
# Code metrics, only manual on staging/master.
################################################################################

# Phpmetrics report, no pass or failure as it's just informative.
phpmetrics:
  stage: php code metrics
  only:
    - branches
  <<: *phpqmetrics_template
  script:
    - ./phpmetrics
        --report-html=${REPORT_DIR}
        --extensions=php,inc,module
        ${PHP_CODE}
  when: manual

# Phploc report, no pass or failure as it's just informative.
phploc:
  stage: php code metrics
  only:
    - branches
  <<: *phpqa_template
  script:
    - phpqa ${PHPQA_REPORT}
        --tools phploc
        ${PHPQA_PHP_CODE}
  when: manual

# Same reports for all Drupal code including our custom.
# Those commands require enough resources from the runner.
phpmetrics All:
  stage: php code metrics
  only:
    - branches
  <<: *phpqmetrics_template
  script:
    - ./phpmetrics
        --report-html=${REPORT_DIR}
        --extensions=php,inc,module
        ${WEB_ROOT}
  cache:
    key: drupal-build-cache
  dependencies:
    - Build
  when: manual

phploc All:
  stage: php code metrics
  only:
    - branches
  <<: *phpqa_template
  script:
    - phpqa ${PHPQA_REPORT}
        --tools phploc
        ${PHPQA_ALL_CODE}
  cache:
    key: drupal-build-cache
  dependencies:
    - Build
  when: manual

################################################################################
# Deploy jobs definition.
#
# This is a sample workflow, testing is run on master and testing branches
# pushes or merge, other deploy are manual. Using a basic bash deploy, you must
# adapt if you are using a specific deploy process.
#
# You need to be sure we can ssh to the machine, a deploy key must be manually
# added on the target in  ~/.ssh/authorized_keys
# Private key name and values must be set on Gitlab:
#   Settings > CI / CD > Variables
################################################################################

Deploy to testing:
  stage: deploy to testing
  environment:
    name: testing
    url: http://${TESTING_HOST}
  before_script: *ssh_agent_template
  script:
    - echo "Deploy to testing"
    - echo -e "${TESTING_PRIVATE_KEY}" > ~/.ssh/id_rsa
    - chmod 400 ~/.ssh/id_rsa
    # We can now ssh and run any deploy script.
    # - ssh $USER_NAME@$TESTING_HOST
    #     "cd ${DRUPAL_FOLDER}; ./scripts/deploy_script.sh;"
  only:
    - testing
    - master

Deploy to staging:
  stage: deploy to staging
  environment:
    name: staging
    url: http://${STAGING_HOST}
  before_script: *ssh_agent_template
  script:
    - echo "Deploy to staging"
    - echo -e "${STAGING_PRIVATE_KEY}" > ~/.ssh/id_rsa
    - chmod 400 ~/.ssh/id_rsa
    # We can now ssh and run any deploy script.
    # - ssh $USER_NAME@$TESTING_HOST
    #     "cd ${DRUPAL_FOLDER}; ./scripts/deploy_script.sh;"
  only:
    - staging
    - master
  when: manual

Deploy to production:
  stage: deploy to production
  environment:
    name: production
    url: http://${PRODUCTION_HOST}
  before_script: *ssh_agent_template
  script:
    - echo "Deploy to production"
    - echo -e "${PRODUCTION_PRIVATE_KEY}" > ~/.ssh/id_rsa
    - chmod 400 ~/.ssh/id_rsa
    # We can now ssh and run any deploy script.
    # - ssh $USER_NAME@$TESTING_HOST
    #     "cd ${DRUPAL_FOLDER}; ./scripts/deploy_script.sh;"
  only:
    - production
    - master
  when: manual

################################################################################
# Cache libraries common to all jobs, see
#   https://docs.gitlab.com/ee/ci/caching/#caching-php-dependencies
################################################################################
cache:
  key: coder
  paths:
    # If we can avoid downloading coder each time.
    - coder

# Default docker image when not overriden.
image: alpine:latest
